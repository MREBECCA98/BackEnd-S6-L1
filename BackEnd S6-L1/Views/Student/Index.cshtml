@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<h1 class="my-3">Aggiungi studente</h1>

<button id="addStudent">Aggiungi studente  </button>

<div class="modal" id="createStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="createStudentModalBody">
            </div>

        </div>
    </div>
</div>


<table class="table">
    <thead>
        <tr>
            <th scope="col">Cognome</th>
            <th scope="col">Nome</th>
            <th scope="col">Data di nascita</th>
            <th scope="col">Email</th>
            <th scope="col">Modifica</th>
            <th scope="col">Elimina</th>
        </tr>
    </thead>
    <tbody id="studentsTableBody">
        
    </tbody>
</table>




@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const addStudent = document.getElementById("addStudent");

            addStudent.addEventListener("click", async () => {

                const res = await fetch("/Student/CreateForm");
                const data = await res.text();
                document.getElementById("createStudentModalBody").innerHTML = data;

                const modalElement = document.getElementById("createStudentModal");
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();

                const createStudentForm = document.getElementById("createStudentForm");

                createStudentForm.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const saveStudentBtn = document.getElementById("saveStudentBtn");
                    const originalBtnText = saveStudentBtn.innerText;

                    let dots = 0;
                    const baseText = "Creazione studente";

                    const interval = setInterval(() => {
                        dots = (dots + 1) % 4;
                        saveStudentBtn.innerText = baseText + ".".repeat(dots);
                    }, 500);

                    const formData = new FormData(createStudentForm);

                    const result = await fetch("/Student/Index", {
                        method: "POST",
                        body: formData
                    });

                    clearInterval(interval);
                    saveStudentBtn.innerText = "Salvataggio...";

                    if (!result.ok) {
                        alert("Errore nel salvataggio");
                        saveStudentBtn.innerText = originalBtnText;
                        return;
                    }

                    // alert("Studente creato con successo!");
                    modal.hide();

                            const tableHtml = await (await fetch("/Student/StudentsTable")).text();
        document.getElementById("studentsTableBody").innerHTML = tableHtml;


                });
            });
        });
    </script>
}
